name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript compiler
        run: npm run type-check

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
        continue-on-error: true

      - name: Check if tests exist
        id: test-check
        run: |
          if [ -d "tests" ] || [ -d "test" ] || [ -d "__tests__" ]; then
            echo "tests_exist=true" >> $GITHUB_OUTPUT
          else
            echo "tests_exist=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No test directory found - skipping test execution"
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        action:
          - kiro-cli-setup
          - kiro-pr-review
          - kiro-issue-review
          - kiro-project-sync
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check if action is implemented
        id: check-impl
        run: |
          if [ -f "actions/${{ matrix.action }}/src/main.ts" ]; then
            echo "implemented=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Action ${{ matrix.action }} is implemented"
          else
            echo "implemented=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Action ${{ matrix.action }} not implemented yet - skipping build"
          fi

      - name: Build TypeScript
        if: steps.check-impl.outputs.implemented == 'true'
        run: npm run build:${{ matrix.action }}

      - name: Verify dist directory exists
        if: steps.check-impl.outputs.implemented == 'true'
        run: |
          if [ ! -d "actions/${{ matrix.action }}/dist" ]; then
            echo "‚ùå Error: dist directory not found for ${{ matrix.action }}"
            exit 1
          fi
          echo "‚úÖ Build successful for ${{ matrix.action }}"

      - name: Upload build artifacts
        if: steps.check-impl.outputs.implemented == 'true' && hashFiles('actions/${{ matrix.action }}/dist/**') != ''
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.action }}
          path: actions/${{ matrix.action }}/dist/
          retention-days: 7

  verify-dependencies:
    name: Verify Zero Third-Party Dependencies
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        action:
          - kiro-cli-setup
          - kiro-pr-review
          - kiro-issue-review
          - kiro-project-sync
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Download build artifacts
        continue-on-error: true
        id: download
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ matrix.action }}
          path: actions/${{ matrix.action }}/dist/

      - name: Check if action is implemented
        id: check-action
        run: |
          if [ ! -d "actions/${{ matrix.action }}" ] || [ "${{ steps.download.outcome }}" == "failure" ]; then
            echo "implemented=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Action ${{ matrix.action }} not implemented yet - skipping dependency verification"
          else
            echo "implemented=true" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check-action.outputs.implemented == 'true'
        run: npm ci

      - name: Audit bundled dependencies
        if: steps.check-action.outputs.implemented == 'true'
        run: |
          echo "üîç Auditing dependencies for ${{ matrix.action }}..."

          # Check if the bundled index.js exists
          BUNDLE_FILE="actions/${{ matrix.action }}/dist/index.js"
          if [ ! -f "$BUNDLE_FILE" ]; then
            echo "‚ùå Error: Bundle file not found at $BUNDLE_FILE"
            exit 1
          fi

          # Extract require() calls from the bundle
          echo "üì¶ Analyzing require() calls in bundle..."
          REQUIRES=$(grep -oP "require\(['\"]([^'\"]+)['\"]\)" "$BUNDLE_FILE" | sort -u || true)

          # Check for third-party dependencies (anything not starting with @actions/ or node:)
          THIRD_PARTY=$(echo "$REQUIRES" | grep -v "require('@actions/" | grep -v "require('node:" | grep -v "^$" || true)

          # Filter out Node.js built-in modules
          BUILTINS="fs|path|crypto|https|http|child_process|os|util|stream|events|buffer|url|querystring|zlib|net|tls|dns|readline|process|assert|string_decoder|timers|tty|vm|worker_threads|perf_hooks|async_hooks|inspector|trace_events|v8|module"
          THIRD_PARTY=$(echo "$THIRD_PARTY" | grep -vE "require\('($BUILTINS)'\)" || true)

          if [ -n "$THIRD_PARTY" ]; then
            echo "‚ùå Error: Third-party dependencies detected in ${{ matrix.action }}:"
            echo "$THIRD_PARTY"
            echo ""
            echo "Only @actions/* packages and Node.js built-ins are allowed."
            exit 1
          fi

          echo "‚úÖ Dependency audit passed for ${{ matrix.action }}"
          echo "‚úÖ Only @actions/* packages and Node.js built-ins detected"

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - lint
      - type-check
      - test
      - build
      - verify-dependencies
    if: always()
    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "‚ùå Lint job failed"
            exit 1
          fi
          if [ "${{ needs.type-check.result }}" != "success" ]; then
            echo "‚ùå Type check job failed"
            exit 1
          fi
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå Build job failed"
            exit 1
          fi
          if [ "${{ needs.verify-dependencies.result }}" != "success" ]; then
            echo "‚ùå Dependency verification job failed"
            exit 1
          fi
          echo "‚úÖ All CI checks passed!"
